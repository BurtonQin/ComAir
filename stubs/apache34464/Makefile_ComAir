CXX=clang
CFLAGS=-O2 -Xclang -disable-O0-optnone -g -flto
LDFLAGS=-use-gold-plugin -Wl,-plugin-opt=save-temps
TARGET=Telnet

HOME_PATH=/home/tzt77/Develop/ComAir
ID_PASS=cmake-build-debug/lib/IDAssigner/libIDAssignerPass.so
MARK_PASS=cmake-build-debug/lib/MarkFlagForAprof/libMarkFlagForAprofPass.so
APROF_PASS=cmake-build-debug/lib/AprofHook/libAProfHookPass.so
INLINE_PASS=cmake-build-debug/lib/MakeFunctionInline/libMakeFunctionInlinePass.so

APROF_LIB=cmake-build-debug/runtime/AProfHooks/libAProfHooks.a

all: Telnet Telnet.aprof

Telnet: Telnet.bc
	${CXX} ${CFLAGS} ${LDFLAGS} Telnet.bc -o Telnet

Telnet.aprof: Telnet.aprof.bc
	${CXX} ${CFLAGS} ${LDFLAGS} Telnet.aprof.bc ${HOME_PATH}/${APROF_LIB} -lm -lrt -o Telnet.aprof

Telnet.aprof.bc: Telnet.mark.id.bc
	opt -load ${HOME_PATH}/${APROF_PASS} -instrument-hooks -strFileName telnet_func_name_id.txt Telnet.mark.id.bc > Telnet.aprof.bc

Telnet.mark.id.bc: Telnet.bc.id
	opt -load ${HOME_PATH}/${MARK_PASS} -mark-flags Telnet.bc.id > Telnet.mark.id.bc

Telnet.bc.id: Telnet.bc
	opt -load ${HOME_PATH}/${ID_PASS} -tag-id Telnet.bc > Telnet.bc.id

Telnet.bc: Telnet.c
	${CXX} ${CFLAGS} Telnet.c -c -o Telnet.bc

clean:
	rm -rf *.o ${TARGET} ${TARGET}.opt *.bc *.resolution.txt *.id Telnet.aprof *.ll *.opt *.bb *.txt