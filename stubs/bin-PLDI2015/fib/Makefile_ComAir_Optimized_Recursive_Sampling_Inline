CXX=clang++
CFLAGS=-O0 -Xclang -disable-O0-optnone -g -flto
LDFLAGS=-use-gold-plugin -Wl,-plugin-opt=save-temps
TARGET=target

HOME_PATH=/home/tzt77/Develop/ComAir
ID_PASS=cmake-build-debug/lib/IDAssigner/libIDAssignerPass.so
APROF_PASS=cmake-build-debug/lib/Sampling/RecursiveInterestedHook/libRecursiveInterestedHookPass.so
SAMPLING_PASS=cmake-build-debug/lib/Sampling/PrepareSampling/libPrepareSamplingPass.so
INLINE_PASS=cmake-build-debug/lib/MakeFunctionInline/libMakeFunctionInlinePass.so

APROF_LIB=cmake-build-debug/runtime/AProfRecursiveHooks/libAProfRecursiveHooks.a
RUNTIME_LIB=stubs/runtime/aproflib-recursive.bc


all: target target.aprof.sampling.inline

target: target.bc
	${CXX} ${CFLAGS} ${LDFLAGS} target.bc -o target

target.aprof.sampling.inline: target.inline.bc
	${CXX} ${CFLAGS} ${LDFLAGS} target.inline.bc -lm -lrt -o target.aprof.sampling.inline

target.inline.bc: target.pre.inline.bc
	opt -load ${HOME_PATH}/${INLINE_PASS} -func-inline -lib-inline 0 target.pre.inline.bc > target.inline.bc

target.pre.inline.bc: target.aprof.bc
	llvm-link ${HOME_PATH}/${RUNTIME_LIB} target.aprof.bc -o target.pre.inline.bc

target.aprof.bc: target.bc.id
	opt -load ${HOME_PATH}/${APROF_PASS} -interested-recursive-hook -is-sampling 1 -strFileName func_name_id.log target.bc.id > target.aprof.bc

target.bc.id: target.pre-sampling.bc
	opt -load ${HOME_PATH}/${ID_PASS} -tag-id target.pre-sampling.bc > target.bc.id

target.pre-sampling.bc: target.merge.bc
	opt -load ${HOME_PATH}/${SAMPLING_PASS} -prepare-sampling -samling-rate 2000  target.merge.bc > target.pre-sampling.bc

target.merge.bc: target.mem.bc
	opt -mergereturn  target.mem.bc > target.merge.bc

target.mem.bc: target.bc
	opt -mem2reg  target.bc > target.mem.bc

target.bc: fib-base.cpp
	${CXX} ${CFLAGS} -c fib-base.cpp -o target.bc

clean:
	rm -rf *.o ${TARGET} ${TARGET}.opt *.bc *.resolution.txt *.id target.aprof.sampling *.ll *.opt *.bb *.txt *.log target.aprof.sampling.inline